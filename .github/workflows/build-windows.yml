# Flight Deal Finder - GitHub Actions CI/CD Workflow
# This workflow builds the Windows installer on every push/PR and creates releases

name: Build Windows Installer

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.0)'
        required: false
        default: '2.0.0'

env:
  PYTHON_VERSION: '3.12'
  APP_NAME: 'FlightDealFinder'

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    # ==========================================================================
    # Setup
    # ==========================================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Get version from tag or input
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
        } elseif ("${{ github.ref_type }}" -eq "tag") {
          $version = "${{ github.ref_name }}".TrimStart("v")
        } else {
          $version = "2.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    # ==========================================================================
    # Install Dependencies
    # ==========================================================================
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install Inno Setup
      shell: pwsh
      run: |
        # Download and install Inno Setup silently
        $installerUrl = "https://jrsoftware.org/download.php/is.exe"
        $installerPath = "$env:TEMP\innosetup.exe"
        
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing
        
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        
        # Add to PATH
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6"
        echo "$innoPath" >> $env:GITHUB_PATH

    # ==========================================================================
    # Build Application
    # ==========================================================================
    - name: Build with PyInstaller
      shell: pwsh
      working-directory: installers/win
      run: |
        Write-Host "Building executable with PyInstaller..."
        pyinstaller --noconfirm --clean `
          --distpath dist `
          --workpath build `
          FlightDealFinder.spec
        
        # Verify build
        if (Test-Path "dist\FlightDealFinder\FlightDealFinder.exe") {
          $size = (Get-Item "dist\FlightDealFinder\FlightDealFinder.exe").Length / 1MB
          Write-Host "Build successful! Executable size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "Build failed: executable not found"
          exit 1
        }

    - name: Build installer with Inno Setup
      shell: pwsh
      working-directory: installers/win
      run: |
        Write-Host "Building installer with Inno Setup..."
        
        # Create output directory
        New-Item -ItemType Directory -Path output -Force | Out-Null
        
        # Compile installer
        $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        & $iscc /Ooutput "/DAppVersion=${{ steps.version.outputs.VERSION }}" installer.iss
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Inno Setup failed"
          exit 1
        }
        
        # List output
        Get-ChildItem output

    # ==========================================================================
    # Upload Artifacts
    # ==========================================================================
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installers/win/output/*.exe
        retention-days: 30

    - name: Upload portable build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: installers/win/dist/FlightDealFinder/
        retention-days: 30

  # ============================================================================
  # Create Release (only on tags)
  # ============================================================================
  release:
    name: Create Release
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-installer
        path: ./release

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./release/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

