name: Release

on:
  push:
    tags:
      - 'v*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows
          - os: macos-14
            artifact_name: macos

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Inno Setup (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: choco install innosetup --no-progress -y

      - name: Build Windows installer
        if: runner.os == 'Windows'
        shell: powershell
        run: .\scripts\ci_build_windows.ps1 -Tag "${{ github.ref_name }}"

      - name: Verify Windows build
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $installer = Get-ChildItem -Path "installers/windows" -Filter "FlightDealFinder-win-x64-*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Error "Windows installer not found!"
            exit 1
          }
          Write-Host "Found installer: $($installer.Name) (Size: $([math]::Round($installer.Length/1MB, 2)) MB)"

      - name: Build macOS app zip
        if: runner.os == 'macOS'
        shell: bash
        run: |
          chmod +x ./scripts/ci_build_macos.sh
          ./scripts/ci_build_macos.sh "${{ github.ref_name }}"

      - name: Verify macOS build
        if: runner.os == 'macOS'
        shell: bash
        run: |
          zip_file=$(find installers/mac/output -name "FlightDealFinder-mac-arm64-*.zip" | head -n 1)
          if [ -z "$zip_file" ]; then
            echo "macOS app bundle not found!"
            exit 1
          fi
          size_mb=$(du -m "$zip_file" | cut -f1)
          echo "Found app bundle: $(basename "$zip_file") (Size: ${size_mb} MB)"

      - name: Upload Windows artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          if-no-files-found: error
          path: installers/windows/FlightDealFinder-win-x64-*.exe

      - name: Upload macOS artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          if-no-files-found: error
          path: installers/mac/output/FlightDealFinder-mac-arm64-*.zip

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release-files

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: release-files

      - name: List release files
        run: |
          echo "Files to be released:"
          ls -lh release-files/
          echo ""
          echo "File count: $(ls -1 release-files/ | wc -l)"

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## FlightDealFinder ${{ github.ref_name }}
          
          ### Downloads
          
          **Windows (x64)**
          - `FlightDealFinder-win-x64-${{ github.ref_name }}.exe` - Windows installer for 64-bit systems
          - Run the installer and follow the setup wizard
          - Windows 10 or later required
          
          **macOS (Apple Silicon)**
          - `FlightDealFinder-mac-arm64-${{ github.ref_name }}.zip` - macOS application for Apple Silicon Macs (M1/M2/M3)
          - Unzip and drag to Applications folder
          - macOS 11 (Big Sur) or later required
          - On first launch, right-click the app and select "Open" if you get a security warning
          
          ### What's New
          
          See the commit history for detailed changes in this release.
          
          ### System Requirements
          
          - **Windows**: Windows 10 or later, 64-bit
          - **macOS**: macOS 11 (Big Sur) or later, Apple Silicon (M1/M2/M3)
          
          ### Support
          
          If you encounter any issues, please open an issue on the GitHub repository.
          EOF
          
          echo "Release notes generated"

      - name: Create/Update GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: FlightDealFinder ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

